AWSTemplateFormatVersion: "2010-09-09"
Description: "ALB stack: Security Group, Application Load Balancer, Target Group, Listener for Tax Service API"

Parameters:
  AppName:
    Type: String
    Default: "tax-service-api"
  Environment:
    Type: String
    Default: "prod"
    AllowedValues:
      - "prod"
      - "staging"
  ContainerPort:
    Type: Number
    Default: "8080"

  # Optional: deploy into an existing VPC/Subnets (e.g., where RDS resides)
  UseExistingNetwork:
    Type: String
    Default: "false"
    AllowedValues: ["true", "false"]
    Description: "Set to true to use ExistingVpcId and ExistingPublicSubnet* parameters instead of network stack exports"
  ExistingVpcId:
    Type: String
    Default: ""
  ExistingPublicSubnet1Id:
    Type: String
    Default: ""
  ExistingPublicSubnet2Id:
    Type: String
    Default: ""

  AcmCertificateArn:
    Type: String
    Description: "ARN of existing ACM certificate for HTTPS listener (e.g., arn:aws:acm:region:account:certificate/uuid)"

Conditions:
  UseExisting: !Equals [!Ref UseExistingNetwork, "true"]

Resources:
  AlbSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "${AppName}-${Environment} ALB SG"
      VpcId: !If
        - UseExisting
        - !Ref ExistingVpcId
        - !ImportValue
          "Fn::Sub": "${AppName}-${Environment}-VpcId"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub "${AppName}-${Environment}-alb-sg"

  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub "${AppName}-${Environment}-alb"
      Scheme: internet-facing
      Type: application
      Subnets:
        - !If
          - UseExisting
          - !Ref ExistingPublicSubnet1Id
          - !ImportValue
            "Fn::Sub": "${AppName}-${Environment}-PublicSubnet1Id"
        - !If
          - UseExisting
          - !Ref ExistingPublicSubnet2Id
          - !ImportValue
            "Fn::Sub": "${AppName}-${Environment}-PublicSubnet2Id"
      SecurityGroups:
        - !Ref AlbSecurityGroup

  AlbTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${AppName}-${Environment}-tg"
      Protocol: HTTP
      Port: !Ref ContainerPort
      VpcId: !If
        - UseExisting
        - !Ref ExistingVpcId
        - !ImportValue
          "Fn::Sub": "${AppName}-${Environment}-VpcId"
      HealthCheckPath: /actuator/health/liveness
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      TargetType: ip
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: "30"

  AlbListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: "443"
            Host: "#{host}"
            Path: "/#{path}"
            Query: "#{query}"
            StatusCode: HTTP_301

  AlbHttpsListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref AcmCertificateArn
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref AlbTargetGroup

Outputs:
  AlbArn:
    Description: ALB ARN
    Value: !Ref ApplicationLoadBalancer
    Export:
      Name: !Sub "${AppName}-${Environment}-AlbArn"

  AlbDNSName:
    Description: ALB DNS Name
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub "${AppName}-${Environment}-AlbDNS"

  AlbSecurityGroupId:
    Description: ALB Security Group Id
    Value: !Ref AlbSecurityGroup
    Export:
      Name: !Sub "${AppName}-${Environment}-AlbSecurityGroupId"

  AlbTargetGroupArn:
    Description: Target Group ARN
    Value: !Ref AlbTargetGroup
    Export:
      Name: !Sub "${AppName}-${Environment}-AlbTargetGroupArn"
